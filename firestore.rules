rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---------------------------
    // BANNERS - ADDED FOR FRONTEND ACCESS
    // ---------------------------
    match /banners/{bannerId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // ---------------------------
    // Public UI / structure doc
    // ---------------------------
    match /categories/structure {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // ---------------------------
    // Categories and nested subcollections
    // ---------------------------
    match /categories/{categoryId} {
      // Current setup: public read/write — change to auth in production if needed
      allow read, write: if true;

      match /subcategories/{subId} {
        allow read, write: if true;

        match /subsubcategories/{subsubId} {
          allow read, write: if true;
        }
      }
    }

    // Standalone category collections
    match /subcategories/{subId} {
      allow read, write: if true;
    }
    match /subsubcategories/{subsubId} {
      allow read, write: if true;
    }

    // Category Banners
    match /categoryBanners/{bannerId} {
      allow read, write: if true;
    }

    // Category Assignments
    match /categoryAssignments/{categoryId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // ---------------------------
    // Products / Services / Catalogs
    // ---------------------------
    match /products/{productId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    match /services/{serviceId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Product Counters / Project Counters
    match /productCounters/{document} {
      allow read, write: if true;
    }
    match /projectCounters/{counterId} {
      allow read, write: if true;
    }

    // ---------------------------
    // Content Collections
    // ---------------------------
    match /blogs/{blogId} {
      allow read, write: if true;
    }
    match /events/{eventId} {
      allow read, write: if true;
    }
    match /content/{docId} {
      allow read, write: if true;
    }
    match /announcements/{docId} {
      // announcements require auth in first rule; kept auth requirement
      allow read: if request.auth != null;
    }

    // ---------------------------
    // Staff & HR
    // ---------------------------
    match /staff/{staffId} {
      // top-level staff: allow read public, write only auth (keeps first rule intent)
      allow read: if true;
      allow write: if request.auth != null;

      match /attendance/{dateId} {
        allow read, write: if request.auth != null;
      }

      match /leaveRequests/{requestId} {
        allow read, write: if request.auth != null;
      }
    }

    // Staff collection duplicate from 2nd file allowed public - already reconciled above.

    // ---------------------------
    // Users (per-user security)
    // ---------------------------
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      match /leads/{leadId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      match /orders/{orderId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ---------------------------
    // Leads / LeadOrder / Lead Subcollections
    // ---------------------------
    match /leads/{leadId} {
      // second file allowed true; kept allow read/write: true
      allow read, write: if true;

      // followUpProofs nested under leads
      match /followUpProofs/{proofId} {
        allow read, write: if true;
      }
    }
    match /leadorder/{leadId} {
      allow read, write: if request.auth != null;
    }

    // ---------------------------
    // Orders / Quotes / Invoices / Payments / Expenses
    // ---------------------------
    match /orders/{orderId} {
      allow read, write: if true;
    }

    match /quotes/{quoteId} {
      allow read, write: if true;
    }

    match /invoices/{invoiceId} {
      allow read, write: if true;
    }

    match /payments/{paymentId} {
      allow read, write: if true;
    }

    match /expenses/{expenseId} {
      allow read, write: if true;
    }

    // ---------------------------
    // Vendors / Suppliers / Material Vendors
    // ---------------------------
    match /vendors/{vendorId} {
      // second rules included validation functions; allow public for current setup
      allow read, write: if true;
      allow create: if isValidVendor(request.resource.data);
      allow update: if isValidVendor(request.resource.data);
    }

    match /suppliers/{document=**} {
      // second file had auth-only; here we kept auth guard per that file
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }

    match /materialVendors/{materialId} {
      allow read, write: if true;
      allow create: if isValidMaterialVendor(request.resource.data);
      allow update: if isValidMaterialVendor(request.resource.data);
    }

    // ---------------------------
    // Vendor Credits / Credit Notes / Bills
    // ---------------------------
    match /vendorCredits/{vendorCreditId} {
      allow read, write: if true;
      allow create: if isValidVendorCredit(request.resource.data);
      allow update: if isValidVendorCredit(request.resource.data);
    }

    match /creditNotes/{creditNoteId} {
      allow read, write: if true;
      allow create: if isValidCreditNote(request.resource.data);
      allow update: if isValidCreditNote(request.resource.data);
    }

    match /bills/{billId} {
      allow read, write: if true;
      allow create: if isValidBill(request.resource.data);
      allow update: if isValidBill(request.resource.data);
    }

    // ---------------------------
    // Projects / Project Groups / Project Tasks / Project Expenses
    // ---------------------------
    match /projectGroups/{groupId} {
      allow read, write: if true;
    }

    // Consolidated projects rules (avoid duplicate match declarations)
    match /projects/{projectId} {
      allow read, write: if true;
    }

    // Generic wildcard versions used in second file: keep them for stricter auth on some operations
    match /projects/{document=**} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }

    match /project-tasks/{document=**} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }

    match /project-expenses/{document=**} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }

    // Also allow read/write (permissive) as some rules declared that
    match /project-tasks/{document} {
      allow read, write: if true;
    }
    match /project-expenses/{expenseId} {
      allow read, write: if true;
    }

    // ---------------------------
    // Tasks / Task(s) / Milestones
    // ---------------------------
    match /tasks/{taskId} {
      allow read, write: if true;
    }

    match /task/{taskId} {
      allow read, write: if true;
    }

    // Milestones (kept from first file)
    match /milestones/{milestoneId} {
      allow read: if true;
      allow write: if request.auth != null;

      match /staffStatus/{staffId} {
        allow read, write: if request.auth != null;
      }

      match /tasks/{taskId} {
        allow read, write: if request.auth != null;
      }

      match /mcq/{questionId} {
        allow read, write: if request.auth != null;
      }
    }

    // ---------------------------
    // Measurements / Photos / Project Updates
    // ---------------------------
    match /measurements/{measurementId} {
      allow read, write: if true;
    }
    match /photos/{photoId} {
      allow read, write: if true;
    }
    match /projectUpdates/{updateId} {
      allow read, write: if true;
    }

    // ---------------------------
    // Notifications / Messages / Presence / Groups
    // ---------------------------
    match /notifications/{notificationId} {
      allow read, write: if true;
    }

    match /messages/{messageId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }

    match /presence/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }

    match /groups/{groupId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }

    // ---------------------------
    // Roles / Departments / Management Teams
    // ---------------------------
    match /roles/{roleId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    match /departments/{deptId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    match /managementTeams/{teamId} {
      allow read, write: if true;
    }

    // ---------------------------
    // Labour / Labour Details / Labour-related
    // ---------------------------
    match /labour/{labourId} {
      allow read, write: if true;
    }

    match /labourDetails/{document=**} {
      // second file said read allowed to authenticated; kept auth requirement
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }

    // ---------------------------
    // Vendors / Suppliers / Customers (reconciled)
    // ---------------------------
    match /customers/{customerId} {
      // first file required auth; second file allowed true. Current merged file allows true for compatibility.
      // Consider changing to: allow read, write: if request.auth != null; in production.
      allow read, write: if true;
      allow create: if isValidCustomer(request.resource.data);
      allow update: if isValidCustomer(request.resource.data);
    }

    // There was also a "customers" match earlier in the first file requiring auth for read/write on 'customers/{document}'.
    // We retained the permissive version above to avoid conflicts.

    // ---------------------------
    // Quotes / Invoices / Site Visits / Sales Orders / Bills
    // ---------------------------
    match /siteVisits/{siteVisitId} {
      allow read, write: if true;
    }
    match /site-visits/{siteVisitId} {
      allow read, write: if true;
    }

    match /salesOrders/{orderId} {
      allow read, write: if true;
    }

    match /bills/{billId} {
      // already declared above with validation; duplicate left out
      allow read, write: if true;
    }

    // ---------------------------
    // Misc Collections
    // ---------------------------
    match /approvals/{approvalId} {
      allow read, write: if true;
    }

    match /productCounters/{document} {
      allow read, write: if true;
    }

    match /vendors/{vendorId} {
      // vendor rules already included above (with validation). This is a second declaration — omitted duplicate.
      allow read, write: if true;
    }

    match /quotes/{quoteId} {
      allow read, write: if true;
    }

    match /bills/{billId} {
      allow read, write: if true;
    }

    match /creditNotes/{creditNoteId} {
      allow read, write: if true;
    }

    match /vendorCredits/{vendorCreditId} {
      allow read, write: if true;
    }

    match /projects/{document=**} {
      allow read, write: if true;
    }

    match /project-tasks/{document=**} {
      allow read, write: if true;
    }

    match /amount-acknowledge/{acknowledgeId} {
      allow read, write: if true;
    }

    match /categoryBanners/{bannerId} {
      allow read, write: if true;
    }

    match /subContractors/{contractorId} {
      allow read, write: if true;
      allow create: if isValidSubContractor(request.resource.data);
      allow update: if isValidSubContractor(request.resource.data);
    }

    match /sitevisitupdate/{siteVisitId} {
      allow read, write: if true;
      allow create: if isValidSiteVisit(request.resource.data);
      allow update: if isValidSiteVisit(request.resource.data);
    }

    match /notifications/{notificationId} {
      allow read, write: if true;
    }

    match /settings/{settingId} {
      allow read, write: if true;
    }

    match /project-expenses/{document=**} {
      allow read, write: if true;
    }

    match /suppliers/{document=**} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }

    match /leads/{leadId}/followUpProofs/{proofId} {
      allow read, write: if true;
    }

    match /materialVendors/{materialId} {
      allow read, write: if true;
      allow create: if isValidMaterialVendor(request.resource.data);
      allow update: if isValidMaterialVendor(request.resource.data);
    }

    // ---------------------------
    // Messages / Presence / Groups already handled above
    // ---------------------------

    // ---------------------------
    // Misc: Measurements, Photos, Project Updates already handled above
    // ---------------------------

    // ---------------------------
    // Notifications, Suppliers, etc handled above
    // ---------------------------

    // ---------------------------
    // Fallback: authenticated access for anything else
    // ---------------------------
    match /{document=**} {
      // safer default: require auth for any collection not explicitly listed above
      allow read, write: if request.auth != null;
    }

    // ---------------------------
    // Validation helper functions
    // ---------------------------
    function isValidCreditNote(data) {
      return data.keys().hasAll([
        'customerName',
        'creditNoteNumber',
        'creditNoteDate',
        'status',
        'total',
        'createdAt',
        'updatedAt'
      ]) &&
      data.customerName is string &&
      data.creditNoteNumber is string &&
      data.creditNoteDate is string &&
      data.status in ['draft', 'open', 'closed'] &&
      data.total is number &&
      data.createdAt is timestamp &&
      data.updatedAt is timestamp;
    }

    function isValidCustomer(data) {
      return data.keys().hasAll([
        'displayName',
        'emailAddress',
        'createdAt',
        'updatedAt'
      ]) &&
      data.displayName is string &&
      data.emailAddress is string &&
      data.createdAt is timestamp &&
      data.updatedAt is timestamp;
    }

    function isValidVendor(data) {
      return data.keys().hasAll([
        'displayName',
        'createdAt',
        'updatedAt'
      ]) &&
      data.displayName is string &&
      data.createdAt is timestamp &&
      data.updatedAt is timestamp &&
      // Optional fields validation
      (data.salutation == null || data.salutation is string) &&
      (data.firstName == null || data.firstName is string) &&
      (data.lastName == null || data.lastName is string) &&
      (data.companyName == null || data.companyName is string) &&
      (data.emailAddress == null || data.emailAddress is string) &&
      (data.phoneNumber == null || data.phoneNumber is string) &&
      (data.gstTreatment == null || data.gstTreatment is string) &&
      (data.sourceOfSupply == null || data.sourceOfSupply is string) &&
      (data.pan == null || data.pan is string) &&
      (data.msmeRegistered == null || data.msmeRegistered is bool) &&
      (data.currency == null || data.currency is string) &&
      (data.openingBalance == null || data.openingBalance is number) &&
      (data.paymentTerms == null || data.paymentTerms is string) &&
      (data.tds == null || data.tds is string) &&
      (data.payables == null || data.payables is number) &&
      (data.unusedCredits == null || data.unusedCredits is number) &&
      (data.status == null || data.status is string);
    }

    function isValidBill(data) {
      return data.keys().hasAll([
        'vendorName',
        'billNumber',
        'billDate',
        'status',
        'totalAmount',
        'createdAt',
        'updatedAt'
      ]) &&
      data.vendorName is string &&
      data.billNumber is string &&
      data.billDate is string &&
      data.status in ['draft', 'open', 'closed', 'paid'] &&
      data.totalAmount is number &&
      data.createdAt is timestamp &&
      data.updatedAt is timestamp &&
      // Optional fields validation
      (data.orderNumber == null || data.orderNumber is string) &&
      (data.dueDate == null || data.dueDate is string) &&
      (data.reverseCharge == null || data.reverseCharge is bool) &&
      (data.paymentTerms == null || data.paymentTerms is string) &&
      (data.items == null || data.items is list) &&
      (data.subTotal == null || data.subTotal is number) &&
      (data.discountPercent == null || data.discountPercent is number) &&
      (data.discountAmount == null || data.discountAmount is number) &&
      (data.adjustmentAmount == null || data.adjustmentAmount is number) &&
      (data.notes == null || data.notes is string) &&
      // Validate items array structure if present
      (data.items == null || (data.items is list && data.items.size() >= 0 &&
        data.items[0].keys().hasAll(['item', 'quantity', 'rate', 'amount']) &&
        data.items[0].item is string &&
        data.items[0].quantity is number &&
        data.items[0].rate is number &&
        data.items[0].amount is number));
    }

    function isValidVendorCredit(data) {
      return data.keys().hasAll([
        'vendorId',
        'vendorName',
        'creditNoteNumber',
        'creditDate',
        'status',
        'subTotal',
        'totalAmount',
        'createdAt',
        'updatedAt'
      ]) &&
      data.vendorId is string &&
      data.vendorName is string &&
      data.creditNoteNumber is string &&
      data.creditDate is string &&
      data.status in ['draft', 'open', 'closed'] &&
      data.subTotal is number &&
      data.totalAmount is number &&
      data.createdAt is timestamp &&
      data.updatedAt is timestamp &&
      // Optional fields validation
      (data.orderNumber == null || data.orderNumber is string) &&
      (data.reverseCharge == null || data.reverseCharge is bool) &&
      (data.items == null || data.items is list) &&
      (data.discount == null || data.discount is number) &&
      (data.discountAmount == null || data.discountAmount is number) &&
      (data.taxType == null || data.taxType in ['TDS', 'TCS']) &&
      (data.taxAmount == null || data.taxAmount is number) &&
      (data.adjustment == null || data.adjustment is number) &&
      (data.notes == null || data.notes is string) &&
      (data.attachments == null || data.attachments is list) &&
      // Validate items array structure if present
      (data.items == null || (data.items is list && data.items.size() >= 0 &&
        data.items[0].keys().hasAll(['itemDetails', 'account', 'quantity', 'rate', 'tax', 'amount']) &&
        data.items[0].itemDetails is string &&
        data.items[0].account is string &&
        data.items[0].quantity is number &&
        data.items[0].rate is number &&
        data.items[0].tax is string &&
        data.items[0].amount is number));
    }

    function isValidMaterialVendor(data) {
      // basic example validation; expand as needed
      return data.keys().hasAll(['displayName', 'createdAt', 'updatedAt']) &&
        data.displayName is string &&
        data.createdAt is timestamp &&
        data.updatedAt is timestamp;
    }

    function isValidSubContractor(data) {
      return data.keys().hasAll(['name', 'createdAt', 'updatedAt']) &&
        data.name is string &&
        data.createdAt is timestamp &&
        data.updatedAt is timestamp;
    }

    function isValidSiteVisit(data) {
      return data.keys().hasAll(['siteId', 'visitDate', 'createdAt', 'updatedAt']) &&
        data.siteId is string &&
        data.visitDate is string &&
        data.createdAt is timestamp &&
        data.updatedAt is timestamp;
    }

  } // end match /databases/{database}/documents
} // end service
